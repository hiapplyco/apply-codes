<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Processing Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pending { background: #fff3cd; border: 1px solid #ffeaa7; }
        .processing { background: #d1ecf1; border: 1px solid #bee5eb; }
        .completed { background: #d4edda; border: 1px solid #c3e6cb; }
        .failed { background: #f8d7da; border: 1px solid #f5c6cb; }
        .content { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; max-height: 200px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .file-info { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Document Processing Test</h1>
    <p>This page tests the new asynchronous document processing workflow.</p>
    
    <div class="upload-area">
        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" />
        <button onclick="uploadFile()">Upload & Process</button>
        <div id="uploadStatus"></div>
    </div>

    <div>
        <button onclick="checkStatus()">Check Status</button>
        <button onclick="listDocuments()">List My Documents</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // Configure your Supabase client
        const supabaseUrl = 'https://kxghaajojntkqrmvsngn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4Z2hhYWpvam50a3FybXZzbmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDk3NTAwNjksImV4cCI6MjAyNTMyNjA2OX0.7Zujbi_5CIXXkp_D5lOgfZ4-r1T9xGNlVvLPB6jZnw4';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        let currentStoragePath = null;

        // Function to validate file
        function validateFile(file) {
            const maxSize = 20 * 1024 * 1024; // 20MB
            const supportedTypes = [
                'application/pdf',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/msword',
                'text/plain',
                'image/jpeg',
                'image/png',
                'image/jpg'
            ];
            const supportedExtensions = ['.pdf', '.docx', '.doc', '.txt', '.jpg', '.jpeg', '.png'];
            
            if (file.size > maxSize) {
                return { valid: false, error: 'File size exceeds 20MB limit' };
            }
            
            const fileName = file.name.toLowerCase();
            const hasValidExtension = supportedExtensions.some(ext => fileName.endsWith(ext));
            const hasValidMimeType = supportedTypes.includes(file.type);
            
            if (!hasValidMimeType && !hasValidExtension) {
                return { valid: false, error: 'Unsupported file type' };
            }
            
            return { valid: true };
        }

        // Upload file function
        window.uploadFile = async function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!file) {
                statusDiv.innerHTML = '<div class="status failed">Please select a file</div>';
                return;
            }
            
            // Validate file
            const validation = validateFile(file);
            if (!validation.valid) {
                statusDiv.innerHTML = `<div class="status failed">Error: ${validation.error}</div>`;
                return;
            }
            
            // Check authentication
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session?.user?.id) {
                statusDiv.innerHTML = '<div class="status failed">Please log in first (you can sign up at localhost:5173)</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status processing">Uploading file...</div>';
            
            try {
                // Generate unique file path
                const timestamp = Date.now();
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const storagePath = `${session.user.id}/${timestamp}-${sanitizedFileName}`;
                currentStoragePath = storagePath;
                
                // Upload to Supabase Storage
                const { error: uploadError } = await supabase.storage
                    .from('docs')
                    .upload(storagePath, file, {
                        contentType: file.type,
                        upsert: false
                    });
                
                if (uploadError) {
                    throw new Error(`Upload failed: ${uploadError.message}`);
                }
                
                statusDiv.innerHTML = `
                    <div class="status completed">File uploaded successfully!</div>
                    <div class="file-info">
                        <strong>File:</strong> ${file.name}<br>
                        <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        <strong>Type:</strong> ${file.type}<br>
                        <strong>Storage Path:</strong> ${storagePath}
                    </div>
                    <div class="status processing">Processing with AI... This may take a few minutes.</div>
                `;
                
                // Start polling for status
                pollForStatus(storagePath);
                
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.innerHTML = `<div class="status failed">Upload failed: ${error.message}</div>`;
            }
        };

        // Poll for processing status
        async function pollForStatus(storagePath, maxRetries = 30) {
            let retries = 0;
            const pollInterval = 3000; // 3 seconds
            
            const poll = async () => {
                try {
                    const { data, error } = await supabase.rpc('get_document_status', {
                        p_storage_path: storagePath
                    });
                    
                    if (error) {
                        console.error('Error getting status:', error);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        const status = data[0];
                        updateStatusDisplay(status);
                        
                        if (status.status === 'completed' || status.status === 'failed') {
                            return; // Stop polling
                        }
                    }
                    
                    if (retries < maxRetries) {
                        retries++;
                        setTimeout(poll, pollInterval);
                    } else {
                        document.getElementById('uploadStatus').innerHTML += 
                            '<div class="status failed">Processing timeout - please check manually</div>';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            };
            
            poll();
        }

        // Update status display
        function updateStatusDisplay(status) {
            const statusDiv = document.getElementById('uploadStatus');
            const statusClass = status.status === 'completed' ? 'completed' : 
                               status.status === 'failed' ? 'failed' : 'processing';
            
            let content = `<div class="status ${statusClass}">Status: ${status.status.toUpperCase()}</div>`;
            
            if (status.status === 'completed' && status.extracted_content) {
                content += `
                    <div class="content">
                        <strong>Extracted Content:</strong><br>
                        ${status.extracted_content.substring(0, 1000)}
                        ${status.extracted_content.length > 1000 ? '...' : ''}
                    </div>
                `;
            }
            
            if (status.status === 'failed' && status.error_message) {
                content += `<div class="status failed">Error: ${status.error_message}</div>`;
            }
            
            statusDiv.innerHTML = content;
        }

        // Check status manually
        window.checkStatus = async function() {
            if (!currentStoragePath) {
                document.getElementById('results').innerHTML = '<div class="status failed">No current upload to check</div>';
                return;
            }
            
            const { data, error } = await supabase.rpc('get_document_status', {
                p_storage_path: currentStoragePath
            });
            
            if (error) {
                document.getElementById('results').innerHTML = `<div class="status failed">Error: ${error.message}</div>`;
                return;
            }
            
            if (data && data.length > 0) {
                updateResultsDisplay([data[0]]);
            } else {
                document.getElementById('results').innerHTML = '<div class="status pending">No status found</div>';
            }
        };

        // List all documents
        window.listDocuments = async function() {
            const { data, error } = await supabase
                .from('user_documents')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
                
            if (error) {
                document.getElementById('results').innerHTML = `<div class="status failed">Error: ${error.message}</div>`;
                return;
            }
            
            updateResultsDisplay(data || []);
        };

        // Update results display
        function updateResultsDisplay(documents) {
            const resultsDiv = document.getElementById('results');
            
            if (documents.length === 0) {
                resultsDiv.innerHTML = '<div class="status pending">No documents found</div>';
                return;
            }
            
            let html = '<h3>Documents:</h3>';
            documents.forEach(doc => {
                const statusClass = doc.processing_status === 'completed' ? 'completed' : 
                                   doc.processing_status === 'failed' ? 'failed' : 'processing';
                
                html += `
                    <div class="status ${statusClass}">
                        <strong>${doc.original_filename}</strong> - ${doc.processing_status.toUpperCase()}<br>
                        <small>Created: ${new Date(doc.created_at).toLocaleString()}</small>
                        ${doc.extracted_content ? `<div class="content">${doc.extracted_content.substring(0, 200)}...</div>` : ''}
                        ${doc.error_message ? `<div style="color: red;">Error: ${doc.error_message}</div>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        // Clear results
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('uploadStatus').innerHTML = '';
            currentStoragePath = null;
        };
        
        // Check authentication on load
        window.addEventListener('load', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session?.user?.id) {
                document.getElementById('results').innerHTML = 
                    '<div class="status pending">Please log in at <a href="http://localhost:5173" target="_blank">localhost:5173</a> to test document processing</div>';
            } else {
                document.getElementById('results').innerHTML = 
                    `<div class="status completed">Logged in as: ${session.user.email}</div>`;
            }
        });
    </script>
</body>
</html>