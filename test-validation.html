<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Validation Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .valid { background: #d4edda; border: 1px solid #c3e6cb; }
        .invalid { background: #f8d7da; border: 1px solid #f5c6cb; }
        .file-info { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>File Validation Test</h1>
    <p>This page tests the new file validation logic.</p>
    
    <input type="file" id="fileInput" multiple />
    <button onclick="testValidation()">Test Validation</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="results"></div>

    <script type="module">
        // Mock DocumentProcessor validation logic
        const SUPPORTED_TYPES = [
            'application/pdf',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/msword',
            'text/plain',
            'image/jpeg',
            'image/png',
            'image/jpg',
            'application/octet-stream',
            'application/zip',
            'application/vnd.ms-word',
            'application/vnd.ms-word.document.macroEnabled.12',
            '',
            'application/x-pdf',
            'text/pdf'
        ];

        const SUPPORTED_EXTENSIONS = ['.pdf', '.docx', '.doc', '.txt', '.jpg', '.jpeg', '.png'];
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

        function validateFile(file) {
            console.log('Validating file:', {
                fileName: file.name,
                fileType: file.type,
                fileSize: file.size,
                fileSizeMB: (file.size / 1024 / 1024).toFixed(2)
            });

            // Check file size
            const fileSizeMB = file.size / 1024 / 1024;
            const maxSizeMB = MAX_FILE_SIZE / 1024 / 1024;
            
            if (file.size > MAX_FILE_SIZE) {
                console.error('File too large:', { fileSizeMB, maxSizeMB });
                return { 
                    valid: false, 
                    error: `File size (${fileSizeMB.toFixed(1)}MB) exceeds ${maxSizeMB}MB limit. Please use a smaller file.` 
                };
            }

            // Check file extension first (more reliable than MIME type)
            const fileName = file.name.toLowerCase();
            const hasValidExtension = SUPPORTED_EXTENSIONS.some(ext => fileName.endsWith(ext));
            
            // If extension is valid, accept the file regardless of MIME type
            if (hasValidExtension) {
                console.log('File validation passed (valid extension):', { fileName, extension: fileName.split('.').pop() });
                return { valid: true };
            }
            
            // If extension check fails, check MIME type as fallback
            const hasValidMimeType = SUPPORTED_TYPES.includes(file.type);

            console.log('File validation (checking MIME type):', {
                fileName,
                fileType: file.type,
                hasValidExtension,
                hasValidMimeType
            });

            // Accept file if MIME type is valid
            if (hasValidMimeType) {
                console.log('File validation passed (valid MIME type)');
                return { valid: true };
            }

            // Neither extension nor MIME type is valid
            console.error('Invalid file type:', { fileType: file.type, fileName });
            return { 
                valid: false, 
                error: `Unsupported file: "${file.name}". Please use: PDF, DOC, DOCX, TXT, JPG, or PNG files` 
            };
        }

        window.testValidation = function() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const resultsDiv = document.getElementById('results');
            
            if (files.length === 0) {
                resultsDiv.innerHTML = '<div class="test-result invalid">Please select at least one file</div>';
                return;
            }
            
            let html = '<h3>Validation Results:</h3>';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const validation = validateFile(file);
                const resultClass = validation.valid ? 'valid' : 'invalid';
                
                html += `
                    <div class="test-result ${resultClass}">
                        <strong>${file.name}</strong> - ${validation.valid ? 'VALID' : 'INVALID'}<br>
                        <div class="file-info">
                            Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                            Type: "${file.type}"<br>
                            Extension: .${file.name.split('.').pop()}
                        </div>
                        ${validation.error ? `<div style="color: red;">Error: ${validation.error}</div>` : ''}
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        };

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('fileInput').value = '';
        };
    </script>
</body>
</html>